# 数据库配置指南

## 当前问题

后端启动时出现数据库连接错误：
```
java.net.ConnectException: Connection refused: no further information
```

这说明 MySQL 服务未启动或数据库未创建。

## 解决步骤

### 第一步：启动 MySQL 服务

#### Windows 方法：

**方法1：使用服务管理器**
1. 按 `Win + R`，输入 `services.msc`，回车
2. 找到 `MySQL` 或 `MySQL80` 服务
3. 右键点击 → "启动"
4. 等待服务状态变为"正在运行"

**方法2：使用命令行（管理员权限）**
```bash
net start MySQL80
```
或者
```bash
net start MySQL
```
（服务名可能不同，请根据实际情况调整）

**方法3：使用 MySQL 安装目录**
```bash
# 进入MySQL安装目录的bin文件夹
cd "C:\Program Files\MySQL\MySQL Server 8.0\bin"
# 启动MySQL服务
mysqld --install
net start MySQL80
```

### 第二步：创建数据库

打开 MySQL 客户端（命令行或图形化工具），执行：

```sql
CREATE DATABASE express_cabinet DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
```

**使用命令行：**
```bash
mysql -u root -p
# 输入密码后，执行上面的CREATE DATABASE语句
```

**使用 MySQL Workbench 或其他图形化工具：**
- 连接到 MySQL 服务器
- 执行上面的 SQL 语句

### 第三步：导入初始化数据

**方法1：命令行导入**
```bash
mysql -u root -p express_cabinet < database/init.sql
```

**方法2：使用 MySQL 客户端**
1. 打开 MySQL Workbench 或 Navicat
2. 连接到 MySQL 服务器
3. 选择 `express_cabinet` 数据库
4. 打开并执行 `database/init.sql` 文件

### 第四步：检查数据库配置

编辑 `backend/src/main/resources/application.yml`：

```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/express_cabinet?useUnicode=true&characterEncoding=utf8&useSSL=false&serverTimezone=Asia/Shanghai
    username: root        # 改为你的MySQL用户名
    password: root        # 改为你的MySQL密码
```

**重要：**
- 如果 MySQL 用户名不是 `root`，请修改 `username`
- 如果 MySQL 密码不是 `root`，请修改 `password`
- 如果 MySQL 端口不是 `3306`，请修改 URL 中的端口号

### 第五步：验证数据库连接

**测试连接：**
```bash
mysql -u root -p -e "USE express_cabinet; SHOW TABLES;"
```

如果能看到表列表（users, cabinets, compartments, express_orders），说明数据库配置正确。

## 快速检查清单

运行后端前，请确认：

- [ ] MySQL 服务已启动
- [ ] 数据库 `express_cabinet` 已创建
- [ ] 已执行 `database/init.sql` 导入数据
- [ ] `application.yml` 中的数据库用户名密码正确
- [ ] MySQL 端口是 3306（或已修改配置）

## 常见问题

### 问题1：找不到 MySQL 服务

**可能原因：**
- MySQL 未安装
- MySQL 服务名称不同

**解决方法：**
1. 检查 MySQL 是否安装：
   ```bash
   mysql --version
   ```
2. 查看所有服务，找到 MySQL 相关服务：
   ```bash
   sc query | findstr MySQL
   ```

### 问题2：忘记 MySQL root 密码

**解决方法：**
1. 停止 MySQL 服务
2. 使用 `--skip-grant-tables` 启动 MySQL
3. 重置密码
4. 重启 MySQL 服务

详细步骤请搜索："Windows MySQL 重置 root 密码"

### 问题3：端口被占用

**检查端口：**
```bash
netstat -ano | findstr :3306
```

**解决方法：**
- 修改 MySQL 端口配置
- 或修改 `application.yml` 中的端口号

### 问题4：防火墙阻止连接

**解决方法：**
- 检查 Windows 防火墙设置
- 确保 MySQL 端口（默认3306）未被阻止

## 测试数据库连接脚本

创建一个测试脚本 `测试数据库连接.bat`：

```batch
@echo off
chcp 65001 >nul
echo ========================================
echo   测试数据库连接
echo ========================================
echo.

echo 正在测试MySQL连接...
mysql -u root -p -e "USE express_cabinet; SHOW TABLES;" 2>nul
if errorlevel 1 (
    echo [错误] 无法连接到数据库
    echo 请检查：
    echo 1. MySQL服务是否启动
    echo 2. 数据库是否已创建
    echo 3. 用户名密码是否正确
) else (
    echo [成功] 数据库连接正常！
)

pause
```

## 完成后的下一步

数据库配置完成后：

1. 重新运行 `启动后端.bat` 或 `使用MavenWrapper运行.bat`
2. 看到 `Started ExpressCabinetApplication` 说明启动成功
3. 然后启动前端服务

## 需要帮助？

如果仍然遇到问题：
1. 检查 MySQL 错误日志
2. 确认 MySQL 版本（需要 8.0+）
3. 查看后端启动日志中的详细错误信息

