# 个人工作内容记录（框架搭建阶段）

## 工作概述

- 完成快递柜综合应用系统的最小可运行版本框架搭建，形成前后端分离工程、数据库初始化与一键启动能力，支持在新电脑快速拉起并演示核心流程。

## 主要工作内容

### 1) 工程结构与基础环境

- 完成工程目录结构与基础配置梳理：
  - `server/backend/`：Spring Boot 后端
  - `web/`：Web 管理端（React + Vite）
  - `server/database/`：MySQL 初始化脚本
  - `app-user/`：用户端小程序（预留目录）
  - `app-server/`：快递员端小程序（预留目录）
- 明确后端配置入口：`server/backend/src/main/resources/application.yml`（端口、数据源、JWT 等）。

### 2) 数据库与初始化脚本

- 基于 MySQL 8.0 设计并初始化核心业务表：
  - `users`、`cabinets`、`compartments`、`express_orders`
- 提供 `server/database/init.sql`，包含建库建表与演示数据/测试账号，保证新环境可快速初始化并演示。

### 3) 后端（Spring Boot + JPA）核心模块

- 完成分层结构与基础骨架（Controller / Service / Repository / Entity / DTO / Util）。
- 统一接口返回结构：`ApiResponse<T>`，固定 `{ code, message, data }`。
- 完成核心接口能力：
  - 认证：注册/登录（BCrypt 密码加密 + JWT token 生成）
  - 快递柜：列表/详情/状态切换、仓门查询、可用仓门筛选、模拟开仓
  - 订单：按手机号/用户查询、创建订单（生成取件码并占用仓门）、取件（释放仓门）

### 4) 前端（React + Vite + Ant Design）管理端

- 完成基础路由与页面框架：
  - 登录页、仪表盘、快递柜管理、订单管理
  - 路由守卫：未登录自动跳转登录页
- 完成接口请求封装与登录态管理：
  - Axios 实例（`baseURL: /api`）与 401 拦截处理
  - token/user 写入 localStorage，并设置默认 Authorization

### 5) 跨平台一键启动脚本

- 提供 `start.js` 作为统一启动入口：
  - 自动检查 Node.js / npm / Docker 环境
  - 自动启动/创建 MySQL 容器并执行初始化脚本
  - 自动启动后端（Maven Wrapper）与前端（Vite）
  - 等待服务就绪后进行冒烟测试（登录 + 调用核心接口）
  - 汇总输出服务端口与访问地址，降低部署与演示成本

## 自测与验证

- 后端：构建/测试通过（`mvnw test`）
- 前端：构建通过（`npm run build`）
- 一键启动：能完成数据库初始化、前后端启动与接口可用性校验

## 文档工作

- 拆分文档结构，便于团队查阅与后续维护：
  - `README.md`：项目说明、技术栈、启动方式、核心方法说明
  - `API.md`：接口文档
  - `DATABASE.md`：数据库文档

## 2026-01-16 前端界面更新记录

- 修复“快递柜管理/智能柜组管理”页面位置列乱码显示：
  - 定位根因：MySQL 会话连接字符集为 latin1，导致初始化脚本中的中文写入后变为乱码
  - 修复方式：初始化脚本增加 `SET NAMES utf8mb4`，并对已落库的乱码数据进行修复还原
  - 修复结果：后端接口返回 `location` 为正常中文，前端表格位置列显示正常

## 2026-01-18 功能修复与体验优化

- 修复“新增快递柜”提交后前端提示成功但数据库未落库的问题：
  - 后端：`CabinetService.createCabinet` 增加参数校验，并为 `status/totalCompartments/powerConsumption` 设置默认值，避免非空字段为 null 导致事务回滚
  - 前端：创建请求补齐 `status/powerConsumption`，并对 `cabinetCode` 做 trim，减少输入误差
- 统一前端对业务错误的处理：Axios 响应拦截器基于 `ApiResponse.code` 判断成功与否（code!=200 视为失败），避免后端业务异常返回 HTTP 200 时前端误报“创建成功”
- 排查并定位 Docker 启动 MySQL 容器失败（init.sql 挂载 not a directory）：结论为旧容器绑定了错误的宿主机路径（`.../database/init.sql`），处理方式为删除旧容器并按正确路径 `server/database/init.sql` 重新创建

## 2026-01-20 Web 登录态持久化与启动故障修复、后端接口完善与鉴权补齐

- 完善 Web 端 token 登录态持久化：启动时从 localStorage 恢复 token/user，并设置 Axios 默认 Authorization
- 增加 JWT 过期校验与自动清理：token 缺失或过期时清除本地缓存并回到未登录态
- 修复前端无法启动（Vite 编译失败）：解决 AuthContext 中重复声明 helper 函数导致的 `Identifier has already been declared`
- 优化路由守卫体验：增加 loading 状态避免刷新时鉴权初始化未完成导致的误跳转
- 补齐服务端 JWT 鉴权：增加拦截器统一校验 `Authorization: Bearer <token>`，默认保护除登录/注册外的所有接口
- 新增登录态查询接口：`GET /api/auth/me` 返回当前登录用户信息
- 补齐订单查询与统计接口：新增订单全量/按柜/按状态查询，以及 `GET /api/stats` 聚合统计
- 完善订单创建/取件关键校验：补齐订单号唯一性、柜/仓匹配、快递柜禁用限制、到期超时判定等
- 统一异常返回结构：参数校验/鉴权失败/通用异常统一封装为 `ApiResponse`
- 收紧跨域配置：CORS 不再放开所有来源，改为读取 `application.yml` 的白名单配置
- 完善文档与演示：API 增加数据字典与权限说明；仪表盘改用 `GET /api/stats` 获取统计数据
- 新增 Web 管理端“用户与快递员管理”页面：支持筛选、查询、新增、编辑、启用/禁用账号
- 新增后端管理员用户管理接口：`/api/users/admin/*`（当前以 `username=admin` 作为管理员判定）
- 增强统计接口：`GET /api/stats` 增加禁用柜组数、仓门故障数、在库仓门数、总日用电量等指标
- Web 端仪表盘同步展示运行指标：禁用柜组、仓门故障、在库仓门、日用电量
- 收敛公网部署配置入口：数据库/JWT/CORS 支持通过环境变量覆盖，避免公网部署时写死敏感配置

## 2026-01-22 系统修复与功能增强

- **系统修复**
  - 修复误删文件问题，回滚项目到稳定版本。
  - 修复 MySQL 容器挂载路径问题，优化 `start.js` 启动脚本支持自动重建容器。
- **Web 端开发**
  - 优化登录机制：实现无操作 10 分钟自动登出功能。
  - 优化交互体验：将“查看仓门”改为弹窗模式。
  - 增加功能特性：智能柜列表新增“空闲仓数”列，并修复显示异常问题。
  - 优化注册流程：登录页增加虚拟短信验证码提示。
  - **支持舱体大小展示**：在仓门详情弹窗中新增“尺寸类型”列（小/中/大），并提供物品存放推荐（如鞋盒、行李箱等）。
- **小程序端开发**
  - 新增“附近快递柜”功能：支持基于地理位置查询最近的快递柜。
  - 修复位置权限问题：完善 `app.json` 中的 `permission` 配置。
  - **支持舱体大小与推荐**：快递柜详情页展示格口尺寸及对应的物品存放建议，优化用户存件体验。
- **后端开发**
  - 支持空闲仓数计算：在 `Cabinet` 实体及 Service 层增加相关计算逻辑。
  - 支持附近搜索：新增 `GET /api/cabinets/nearby` 等接口。
  - **支持舱体大小管理**：数据库新增 `size_type` 字段，并在初始化时预设多样化的尺寸分布。
- **数据增强**
  - 丰富初始化数据：新增 5 组不同位置的快递柜（包括西单、三里屯、北京南站等），覆盖正常、禁用、混合占用、全大号仓等多种业务场景。
