# 个人工作内容记录（框架搭建阶段）

## 工作概述

- 完成快递柜综合应用系统的最小可运行版本框架搭建，形成前后端分离工程、数据库初始化与一键启动能力，支持在新电脑快速拉起并演示核心流程。

## 主要工作内容

### 1) 工程结构与基础环境

- 完成工程目录结构与基础配置梳理：
  - `server/backend/`：Spring Boot 后端
  - `web/`：Web 管理端（React + Vite）
  - `server/database/`：MySQL 初始化脚本
  - `app-user/`：用户端小程序（预留目录）
  - `app-server/`：快递员端小程序（预留目录）
- 明确后端配置入口：`server/backend/src/main/resources/application.yml`（端口、数据源、JWT 等）。

### 2) 数据库与初始化脚本

- 基于 MySQL 8.0 设计并初始化核心业务表：
  - `users`、`cabinets`、`compartments`、`express_orders`
- 提供 `server/database/init.sql`，包含建库建表与演示数据/测试账号，保证新环境可快速初始化并演示。

### 3) 后端（Spring Boot + JPA）核心模块

- 完成分层结构与基础骨架（Controller / Service / Repository / Entity / DTO / Util）。
- 统一接口返回结构：`ApiResponse<T>`，固定 `{ code, message, data }`。
- 完成核心接口能力：
  - 认证：注册/登录（BCrypt 密码加密 + JWT token 生成）
  - 快递柜：列表/详情/状态切换、仓门查询、可用仓门筛选、模拟开仓
  - 订单：按手机号/用户查询、创建订单（生成取件码并占用仓门）、取件（释放仓门）

### 4) 前端（React + Vite + Ant Design）管理端

- 完成基础路由与页面框架：
  - 登录页、仪表盘、快递柜管理、订单管理
  - 路由守卫：未登录自动跳转登录页
- 完成接口请求封装与登录态管理：
  - Axios 实例（`baseURL: /api`）与 401 拦截处理
  - token/user 写入 localStorage，并设置默认 Authorization

### 5) 跨平台一键启动脚本

- 提供 `start.js` 作为统一启动入口：
  - 自动检查 Node.js / npm / Docker 环境
  - 自动启动/创建 MySQL 容器并执行初始化脚本
  - 自动启动后端（Maven Wrapper）与前端（Vite）
  - 等待服务就绪后进行冒烟测试（登录 + 调用核心接口）
  - 汇总输出服务端口与访问地址，降低部署与演示成本

## 自测与验证

- 后端：构建/测试通过（`mvnw test`）
- 前端：构建通过（`npm run build`）
- 一键启动：能完成数据库初始化、前后端启动与接口可用性校验

## 文档工作

- 拆分文档结构，便于团队查阅与后续维护：
  - `README.md`：项目说明、技术栈、启动方式、核心方法说明
  - `API.md`：接口文档
  - `DATABASE.md`：数据库文档

## 2026-01-14

- [x] 新增跨平台启动脚本 start.sh（macOS/Linux）
- [x] 优化 Windows 启动脚本 一键启动.bat（环境检查、自动安装前端依赖）
- [x] 修复 MySQL 连接报错（allowPublicKeyRetrieval）
- [x] 修复测试账号密码与 BCrypt 校验不一致问题（更新 init.sql 哈希）

## 2026-01-15

- [x] 新增全平台一键启动脚本 `start.js`：自动启动 MySQL（Docker）+ 后端 + 前端
- [x] 一键脚本增加实时进度输出、错误提醒、冒烟测试与最终端口/访问地址汇总
- [x] 移除旧启动脚本：`start.sh`、`一键启动.bat`
- [x] 完善项目文档：补充 API 文档、数据库表结构与核心方法说明

## 2026-01-16 前端界面更新记录

- 修复“快递柜管理/智能柜组管理”页面位置列乱码显示：
  - 定位根因：MySQL 会话连接字符集为 latin1，导致初始化脚本中的中文写入后变为乱码
  - 修复方式：初始化脚本增加 `SET NAMES utf8mb4`，并对已落库的乱码数据进行修复还原
  - 修复结果：后端接口返回 `location` 为正常中文，前端表格位置列显示正常

## 2026-01-17

- [x] **前端架构修复**：
  - [x] 修复目录重构后 `web/src` 下组件与页面的相对路径引用错误。
  - [x] 调整 `vite.config.js` 配置，优化构建输出路径。
- [x] **接口连通性验证**：
  - [x] 配置后端 `WebMvcConfig` 以允许跨域请求（CORS），解决前端 `Axios` 请求被拦截问题。
  - [x] 使用 Postman 测试 Web 端核心接口，确保 `ApiResponse` 结构符合预期。
- [x] **文档建设**：
  - [x] 整理前后端接口文档，明确 User/Cabinet 实体字段定义与数据类型。

## 2026-01-18 功能修复与体验优化

- 修复“新增快递柜”提交后前端提示成功但数据库未落库的问题：
  - 后端：`CabinetService.createCabinet` 增加参数校验，并为 `status/totalCompartments/powerConsumption` 设置默认值，避免非空字段为 null 导致事务回滚
  - 前端：创建请求补齐 `status/powerConsumption`，并对 `cabinetCode` 做 trim，减少输入误差
- 统一前端对业务错误的处理：Axios 响应拦截器基于 `ApiResponse.code` 判断成功与否（code!=200 视为失败），避免后端业务异常返回 HTTP 200 时前端误报“创建成功”
- 排查并定位 Docker 启动 MySQL 容器失败（init.sql 挂载 not a directory）：结论为旧容器绑定了错误的宿主机路径（`.../database/init.sql`），处理方式为删除旧容器并按正确路径 `server/database/init.sql` 重新创建

## 2026-01-19

- [x] **安全认证模块设计**：
  - [x] 引入 `jjwt` 库，设计基于 JWT (JSON Web Token) 的无状态身份认证流程。
  - [x] 集成 `BCryptPasswordEncoder` 到 `AuthService`，实现用户密码的加盐哈希存储与校验。
- [x] **权限控制规划**：
  - [x] 规划 `JwtAuthenticationFilter` 拦截器，定义公共接口（如登录/注册）与受保护接口的访问策略。

## 2026-01-20 Web 登录态持久化与启动故障修复、后端接口完善与鉴权补齐

- 完善 Web 端 token 登录态持久化：启动时从 localStorage 恢复 token/user，并设置 Axios 默认 Authorization
- 增加 JWT 过期校验与自动清理：token 缺失或过期时清除本地缓存并回到未登录态
- 修复前端无法启动（Vite 编译失败）：解决 AuthContext 中重复声明 helper 函数导致的 `Identifier has already been declared`
- 优化路由守卫体验：增加 loading 状态避免刷新时鉴权初始化未完成导致的误跳转
- 补齐服务端 JWT 鉴权：增加拦截器统一校验 `Authorization: Bearer <token>`，默认保护除登录/注册外的所有接口
- 新增登录态查询接口：`GET /api/auth/me` 返回当前登录用户信息
- 补齐订单查询与统计接口：新增订单全量/按柜/按状态查询，以及 `GET /api/stats` 聚合统计
- 完善订单创建/取件关键校验：补齐订单号唯一性、柜/仓匹配、快递柜禁用限制、到期超时判定等
- 统一异常返回结构：参数校验/鉴权失败/通用异常统一封装为 `ApiResponse`
- 收紧跨域配置：CORS 不再放开所有来源，改为读取 `application.yml` 的白名单配置
- 完善文档与演示：API 增加数据字典与权限说明；仪表盘改用 `GET /api/stats` 获取统计数据
- 新增 Web 管理端“用户与快递员管理”页面：支持筛选、查询、新增、编辑、启用/禁用账号
- 新增后端管理员用户管理接口：`/api/users/admin/*`（当前以 `username=admin` 作为管理员判定）
- 增强统计接口：`GET /api/stats` 增加禁用柜组数、仓门故障数、在库仓门数、总日用电量等指标
- Web 端仪表盘同步展示运行指标：禁用柜组、仓门故障、在库仓门、日用电量
- 收敛公网部署配置入口：数据库/JWT/CORS 支持通过环境变量覆盖，避免公网部署时写死敏感配置

## 2026-01-21

- [x] **用户管理模块开发**：
  - [x] 前端开发 `UserManagement.jsx`，集成 Ant Design `Table` 组件展示用户列表。
  - [x] 实现基于角色的筛选功能（用户/快递员/管理员）与分页查询。
- [x] **后端权限调试**：
  - [x] 调试 `UserService` 中的管理员权限校验逻辑，确保非管理员无法操作用户数据。

## 2026-01-22 系统修复与功能增强

- **系统修复**
  - 修复误删文件问题，回滚项目到稳定版本。
  - 修复 MySQL 容器挂载路径问题，优化 `start.js` 启动脚本支持自动重建容器。
- **Web 端开发**
  - 优化登录机制：实现无操作 10 分钟自动登出功能。
  - 优化交互体验：将“查看仓门”改为弹窗模式。
  - 增加功能特性：智能柜列表新增“空闲仓数”列，并修复显示异常问题。
  - 优化注册流程：登录页增加虚拟短信验证码提示。
  - **支持舱体大小展示**：在仓门详情弹窗中新增“尺寸类型”列（小/中/大），并提供物品存放推荐（如鞋盒、行李箱等）。
- **小程序端开发**
  - 新增“附近快递柜”功能：支持基于地理位置查询最近的快递柜。
  - 修复位置权限问题：完善 `app.json` 中的 `permission` 配置。
  - **支持舱体大小与推荐**：快递柜详情页展示格口尺寸及对应的物品存放建议，优化用户存件体验。
- **后端开发**
  - 支持空闲仓数计算：在 `Cabinet` 实体及 Service 层增加相关计算逻辑。
  - 支持附近搜索：新增 `GET /api/cabinets/nearby` 等接口。
  - **支持舱体大小管理**：数据库新增 `size_type` 字段，并在初始化时预设多样化的尺寸分布。
- **数据增强**
  - 丰富初始化数据：新增 5 组不同位置的快递柜（包括西单、三里屯、北京南站等），覆盖正常、禁用、混合占用、全大号仓等多种业务场景。

## 2026-01-23

- [x] **快递员功能开发**：
  - [x] 开发 `pages/deliver/deliver.wxml` 页面，实现快递员投递流程。
  - [x] 集成 `wx.scanCode` API 模拟扫码开柜，调用后端 `CabinetService.openCompartment` 接口。
- [x] **后端单元测试**：
  - [x] 编写 `CabinetServiceTest`，覆盖“开柜”、“占用状态更新”等核心业务逻辑。

## 2026-01-24

- [x] **功能探索与数据库调整**：
  - [x] 尝试在 `CabinetService` 中实现基于物品体积的智能推荐柜门算法（因复杂度过高暂时搁置）。
  - [x] 修改数据库 `compartments` 表，预留 `size_type` 字段（SMALL/MEDIUM/LARGE），为未来功能做准备。
- [x] **日志优化**：
  - [x] 优化全局异常处理器 `GlobalExceptionHandler`，增加详细的错误堆栈与请求参数日志。

## 2026-01-25

- [x] **性能调优**：
  - [x] 数据库优化：为 `orders` 表的高频查询字段 `status` 和 `cabinet_id` 添加索引，提升查询效率。
  - [x] 代码优化：重构 `StatsService` 中的统计 SQL，将多次单表查询合并为聚合查询。
- [x] **代码清理**：
  - [x] 移除前端项目中冗余的 `console.log` 调试语句，规范代码风格。

## 2026-01-26

- [x] **小程序体验优化**：
  - [x] 完善 `pages/orders/orders` 页面，增加顶部 Tab 栏切换订单状态（待取件/已完成）。
  - [x] 修复自定义 TabBar (`custom-tab-bar`) 在不同页面间切换时图标选中状态不更新的问题。
- [x] **部署文档**：
  - [x] 编写项目部署文档初稿，记录 Docker 环境搭建与 Nginx 反向代理配置要点。

## 2026-01-27

- [x] **全链路测试**：
  - [x] 执行集成测试：模拟完整流程（用户注册 -> 快递员投递 -> 用户收到通知 -> 用户取件）。
- [x] **问题发现**：
  - [x] 发现快递员端“待取件”列表中，`senderName` 等字段显示为 `NULL`，定位到后端 DTO 映射问题。
- [x] **版本规划**：
  - [x] 记录现有 Bug 与未完成特性，决定进行一次代码回退与重构，以稳固核心功能。

## 2026-01-28

- [x] **核心架构调整**：
  - [x] 回退代码至稳定版本（Commit: `239938e4`），确保“Web端 + 用户端小程序 + 快递员端小程序”三端核心功能互通。
  - [x] 清理冗余代码与不可用的实验性功能（如未完成的尺寸推荐逻辑），保证系统稳定性。
- [x] **缺陷修复**：
  - [x] **启动脚本修复**：修正 `start.js` 中数据库连接密码与 `application.yml` 不一致的问题（统一为 `123456`），解决后端无法启动的故障。
  - [x] **快递员小程序修复**：解决“待取件订单”列表中发件人信息显示 `null` 的问题。针对快递投递的订单（OrderType=0），改为优先显示收件人信息，优化信息展示逻辑。
- [x] **文档更新**：
  - [x] 重构 `README.md`：
    - [x] 更新项目结构说明，明确标识 `user_xcx`（用户端）和 `app_server`（快递员端）目录。
    - [x] 补充最新的技术栈说明（Spring Boot 2.7 + React 18 + 微信小程序原生）。
    - [x] 更新一键启动与手动启动的详细步骤，修正数据库默认密码说明。
  - [x] 更新 `CHANGELOG.md` 记录本次维护内容。
